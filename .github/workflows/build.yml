name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16.x'
        cache: 'yarn'

    - name: Set up Python (for native modules)
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: pip3 install setuptools

    - name: Install dependencies
      run: yarn install --frozen-lockfile

    - name: Build application
      run: yarn run build

    - name: Package application (Windows)
      if: matrix.os == 'windows-latest'
      run: yarn run dist
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Package application (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # 先构建 x64 架构
        electron-builder --mac --x64
        # 清理临时文件
        rm -rf dist/mac
        # 构建 arm64 架构
        electron-builder --mac --arm64
        # 清理临时文件
        rm -rf dist/mac
        # 构建通用二进制文件 (universal)
        electron-builder --mac --universal
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Package application (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y rpm libarchive-tools
        yarn run dist
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Windows artifacts
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: windows-builds
        path: |
          dist/*.exe
          dist/*.7z

    - name: Upload macOS artifacts
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: macos-builds
        path: |
          dist/*x64*.dmg
          dist/*x64*.zip
          dist/*arm64*.dmg
          dist/*arm64*.zip
          dist/*universal*.dmg
          dist/*universal*.zip

    - name: Upload Linux artifacts
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: linux-builds
        path: |
          dist/*.deb
          dist/*.rpm
          dist/*.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/windows-builds/*.exe
          dist/windows-builds/*.7z
          dist/macos-builds/*.dmg
          dist/macos-builds/*.zip
          dist/linux-builds/*.deb
          dist/linux-builds/*.rpm
          dist/linux-builds/*.tar.gz
        draft: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}