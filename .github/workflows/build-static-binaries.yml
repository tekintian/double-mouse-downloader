name: Build Static Binaries
on:
  push:
    branches: [ dev ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ dev ]
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build Windows binaries'
        required: false
        default: 'true'
      build_macos_arm64:
        description: 'Build macOS ARM64 binaries'
        required: false
        default: 'true'
      build_macos_x64:
        description: 'Build macOS Intel binaries'
        required: false
        default: 'true'
      build_linux:
        description: 'Build Linux binaries'
        required: false
        default: 'true'
      upload_to_release:
        description: 'Upload binaries to GitHub Releases (tag v1)'
        required: false
        default: 'false'
      release_tag:
        description: 'Release tag (e.g., v1)'
        required: false
        default: 'v1'

jobs:
  # 暂时只构建 Linux，其他平台先跳过
  build_linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential autoconf automake libtool pkg-config yasm nasm

    - name: Build static binaries
      run: |
        chmod +x scripts/build-static-binaries.sh
        scripts/build-static-binaries.sh linux x64

    - name: Verify binaries
      run: |
        echo "验证 Linux 二进制文件..."
        ls -lh bin/linux/x64/ffmpeg bin/linux/x64/aria2c
        file bin/linux/x64/ffmpeg bin/linux/x64/aria2c

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-linux-x64
        path: bin/linux/x64/*
        retention-days: 7

  # 合并并打包所有二进制文件
  package:
    # 只有在选择了上传到 Release 时才运行
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.upload_to_release == 'true'
    needs: [build_linux]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # 下载所有构建产物
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: bin-artifacts

    # 重组 bin 目录结构
    - name: Organize bin directory
      run: |
        mkdir -p bin

        # Linux
        if [ -d "bin-artifacts/binaries-linux-x64" ]; then
          mkdir -p bin/linux/x64
          cp bin-artifacts/binaries-linux-x64/* bin/linux/x64/
        fi

        # 显示目录结构
        tree bin || find bin -type f -ls

    # 压缩为 zip 文件
    - name: Create zip archive
      run: |
        zip -r static-binaries-all-platforms.zip bin/*

        # 显示文件大小
        ls -lh static-binaries-all-platforms.zip

        # 显示压缩包内容
        unzip -l static-binaries-all-platforms.zip

    # 上传到 GitHub Releases
    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: static-binaries-all-platforms.zip
        tag_name: ${{ inputs.release_tag }}
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
