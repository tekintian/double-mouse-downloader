name: Build Static Binaries

on:
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build Windows binaries'
        required: false
        default: 'true'
      build_macos_arm64:
        description: 'Build macOS ARM64 binaries'
        required: false
        default: 'true'
      build_macos_x64:
        description: 'Build macOS Intel binaries'
        required: false
        default: 'true'
      build_linux:
        description: 'Build Linux binaries'
        required: false
        default: 'true'
      upload_to_release:
        description: 'Upload binaries to GitHub Releases (tag v1)'
        required: false
        default: 'false'
      release_tag:
        description: 'Release tag (e.g., v1)'
        required: false
        default: 'v1'

jobs:
  build_windows:
    runs-on: windows-latest
    steps:
    - name: Debug inputs
      run: |
        echo "=== Debug Inputs ==="
        echo "build_windows: '${{ inputs.build_windows }}'"
        echo "build_macos_arm64: '${{ inputs.build_macos_arm64 }}'"
        echo "build_macos_x64: '${{ inputs.build_macos_x64 }}'"
        echo "build_linux: '${{ inputs.build_linux }}'"
        echo "upload_to_release: '${{ inputs.upload_to_release }}'"
        echo "=================="

    - name: Checkout code
      if: ${{ inputs.build_windows == 'true' || inputs.build_windows == '' }}
      uses: actions/checkout@v3

    - name: Build static binaries
      if: ${{ inputs.build_windows == 'true' || inputs.build_windows == '' }}
      run: |
        powershell -ExecutionPolicy Bypass -File scripts/build-static-binaries.ps1

    - name: Verify binaries
      if: ${{ inputs.build_windows == 'true' || inputs.build_windows == '' }}
      run: |
        echo "验证 Windows 二进制文件..."
        ls -lh bin/win32/x64/ffmpeg.exe bin/win32/x64/aria2c.exe
      shell: bash

    - name: Upload artifacts
      if: ${{ inputs.build_windows == 'true' || inputs.build_windows == '' }}
      uses: actions/upload-artifact@v4
      with:
        name: binaries-win32-x64
        path: bin/win32/x64/*
        retention-days: 7

  build_macos_arm64:
    runs-on: macos-15
    steps:
    - name: Checkout code
      if: ${{ inputs.build_macos_arm64 == 'true' || inputs.build_macos_arm64 == '' }}
      uses: actions/checkout@v3

    - name: Install build dependencies
      if: ${{ inputs.build_macos_arm64 == 'true' || inputs.build_macos_arm64 == '' }}
      run: |
        brew install autoconf automake libtool pkg-config yasm nasm
        # ffmpeg 依赖
        brew install x264
        # aria2 依赖
        brew install libssh2 libxml2

    - name: Build static binaries
      if: ${{ inputs.build_macos_arm64 == 'true' || inputs.build_macos_arm64 == '' }}
      run: |
        chmod +x scripts/build-static-binaries.sh
        scripts/build-static-binaries.sh darwin arm64

    - name: Verify binaries
      if: ${{ inputs.build_macos_arm64 == 'true' || inputs.build_macos_arm64 == '' }}
      run: |
        echo "验证 macOS ARM64 二进制文件..."
        ls -lh bin/darwin/arm64/ffmpeg bin/darwin/arm64/aria2c

    - name: Upload artifacts
      if: ${{ inputs.build_macos_arm64 == 'true' || inputs.build_macos_arm64 == '' }}
      uses: actions/upload-artifact@v4
      with:
        name: binaries-darwin-arm64
        path: bin/darwin/arm64/*
        retention-days: 7

  build_macos_x64:
    runs-on: macos-15-intel
    steps:
    - name: Checkout code
      if: ${{ inputs.build_macos_x64 == 'true' || inputs.build_macos_x64 == '' }}
      uses: actions/checkout@v3

    - name: Install build dependencies
      if: ${{ inputs.build_macos_x64 == 'true' || inputs.build_macos_x64 == '' }}
      run: |
        brew install autoconf automake libtool pkg-config yasm nasm
        # ffmpeg 依赖
        brew install x264
        # aria2 依赖
        brew install libssh2 libxml2

    - name: Build static binaries
      if: ${{ inputs.build_macos_x64 == 'true' || inputs.build_macos_x64 == '' }}
      run: |
        chmod +x scripts/build-static-binaries.sh
        scripts/build-static-binaries.sh darwin x64

    - name: Verify binaries
      if: ${{ inputs.build_macos_x64 == 'true' || inputs.build_macos_x64 == '' }}
      run: |
        echo "验证 macOS Intel 二进制文件..."
        ls -lh bin/darwin/x64/ffmpeg bin/darwin/x64/aria2c

    - name: Upload artifacts
      if: ${{ inputs.build_macos_x64 == 'true' || inputs.build_macos_x64 == '' }}
      uses: actions/upload-artifact@v4
      with:
        name: binaries-darwin-x64
        path: bin/darwin/x64/*
        retention-days: 7

  build_linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      if: ${{ inputs.build_linux == 'true' || inputs.build_linux == '' }}
      uses: actions/checkout@v3

    - name: Install build dependencies
      if: ${{ inputs.build_linux == 'true' || inputs.build_linux == '' }}
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential autoconf automake libtool pkg-config yasm nasm
        # ffmpeg 依赖
        sudo apt-get install -y libx264-dev
        # aria2 依赖
        sudo apt-get install -y libssh2-1-dev libxml2-dev libexpat1-dev

    - name: Build static binaries
      if: ${{ inputs.build_linux == 'true' || inputs.build_linux == '' }}
      run: |
        chmod +x scripts/build-static-binaries.sh
        scripts/build-static-binaries.sh linux x64

    - name: Verify binaries
      if: ${{ inputs.build_linux == 'true' || inputs.build_linux == '' }}
      run: |
        echo "验证 Linux 二进制文件..."
        ls -lh bin/linux/x64/ffmpeg bin/linux/x64/aria2c

    - name: Upload artifacts
      if: ${{ inputs.build_linux == 'true' || inputs.build_linux == '' }}
      uses: actions/upload-artifact@v4
      with:
        name: binaries-linux-x64
        path: bin/linux/x64/*
        retention-days: 7

  # 合并并打包所有二进制文件
  package:
    # 只有在选择了上传到 Release 时才运行
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.upload_to_release == 'true' &&
      (inputs.build_windows == 'true' || inputs.build_macos_arm64 == 'true' ||
       inputs.build_macos_x64 == 'true' || inputs.build_linux == 'true')
    needs: [build_windows, build_macos_arm64, build_macos_x64, build_linux]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # 下载所有构建产物
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: bin-artifacts

    # 重组 bin 目录结构
    - name: Organize bin directory
      run: |
        mkdir -p bin

        # macOS ARM64
        if [ -d "bin-artifacts/binaries-darwin-arm64" ]; then
          mkdir -p bin/darwin/arm64
          cp bin-artifacts/binaries-darwin-arm64/* bin/darwin/arm64/
        fi

        # macOS Intel
        if [ -d "bin-artifacts/binaries-darwin-x64" ]; then
          mkdir -p bin/darwin/x64
          cp bin-artifacts/binaries-darwin-x64/* bin/darwin/x64/
        fi

        # Linux
        if [ -d "bin-artifacts/binaries-linux-x64" ]; then
          mkdir -p bin/linux/x64
          cp bin-artifacts/binaries-linux-x64/* bin/linux/x64/
        fi

        # Windows
        if [ -d "bin-artifacts/binaries-win32-x64" ]; then
          mkdir -p bin/win32/x64
          cp bin-artifacts/binaries-win32-x64/* bin/win32/x64/
        fi

        # 显示目录结构
        tree bin || find bin -type f -ls

    # 压缩为 zip 文件
    - name: Create zip archive
      run: |
        zip -r static-binaries-all-platforms.zip bin/*

        # 显示文件大小
        ls -lh static-binaries-all-platforms.zip

        # 显示压缩包内容
        unzip -l static-binaries-all-platforms.zip

    # 上传到 GitHub Releases
    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: static-binaries-all-platforms.zip
        tag_name: ${{ inputs.release_tag }}
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
